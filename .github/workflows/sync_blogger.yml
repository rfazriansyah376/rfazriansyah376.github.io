name: Sync Blogger Feed to Jekyll

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  update-feed:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Fetch Blogger Feed
        run: |
          curl -s "https://www.xcelebgram.my.id/feeds/posts/default?start-index=1&max-results=9999&alt=json" > blogger_feed.json

      - name: Convert JSON to Jekyll Format
        run: |
          mkdir -p _posts
          jq -r '
            .feed.entry[]? |
            (.title.$t // "Untitled") as $title |
            (.published.$t | sub("T.*";"")) as $date |
            (.category? | map(.term) | join(", ") // "uncategorized") as $categories |
            (.media$thumbnail?.url // "https://via.placeholder.com/600") as $image |
            (.content.$t // "No content available") as $content |
            (.link[] | select(.rel == "alternate") | .href) as $post_url |
            ($title | gsub("[^a-zA-Z0-9]+"; "-") | ascii_downcase) as $slug |
            "---\nlayout: post\ntitle: \"" + $title + "\"\nauthor: admin\ncategories: [" + $categories + "]\nimage: \"" + $image + "\"\n---\n\n" + $content' blogger_feed.json > temp_posts.txt

          while IFS= read -r line; do
            if [[ $line == "---" ]]; then
              if [[ -n "$post_data" ]]; then
                post_file="_posts/${post_date}-${post_slug}.html"
                echo "$post_data" > "$post_file"
              fi
              post_data="$line"
              post_date=""
              post_slug=""
            else
              post_data+=$'\n'"$line"
              [[ $line == "date: "* ]] && post_date=$(echo $line | cut -d' ' -f2)
              [[ $line == "title: "* ]] && post_slug=$(echo $line | awk -F '"' '{print $2}' | tr '[:upper:]' '[:lower:]' | tr -s ' ' '-' | tr -dc 'a-z0-9-')
            fi
          done < temp_posts.txt

          if [[ -n "$post_data" ]]; then
            post_file="_posts/${post_date}-${post_slug}.html"
            echo "$post_data" > "$post_file"
          fi

      - name: Commit and Push Changes
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add _posts/
          git commit -m "Update Blogger Feed to Jekyll" || exit 0
          git push
