name: Sync Blogger Feed to Jekyll Format

on:
  schedule:
    - cron: "0 0 * * *" # Jalankan setiap hari pukul 00:00 UTC
  workflow_dispatch: # Bisa dijalankan secara manual

jobs:
  update-feed:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Fetch Blogger Feed
        run: |
          curl -s "https://xcelebgram.my.id/feeds/posts/default?start-index=1&max-results=9999&alt=json" > blogger_feed.json

      - name: Convert JSON to Jekyll Format
        run: |
          mkdir -p _posts
          jq -r '.feed.entry[] | 
            (.published.$t | sub("T.*";"")) as $date |
            (.published.$t | sub("Z";"") | sub("T";" ")) as $datetime |
            ($date | split("-") | .[0] + "/" + .[1] + "/" + .[2]) as $path |
            (.title.$t | gsub("[^a-zA-Z0-9]+"; "-") | ascii_downcase) as $slug |
            ((.category | map(.term)) // ["uncategorized"]) as $categories |
            ((.media$thumbnail.url)? // "https://via.placeholder.com/600") as $image |
            ("---\nlayout: xp\ntitle: \"" + .title.$t + "\"\nauthor: admin\ncategories: " + ($categories | tostring) + "\nimage: \"" + $image + "\"\ndate: " + $datetime + "\n---\n\n" + .content.$t) as $content |
            ("mkdir -p _posts/" + $path + " && echo '" + $content + "' > _posts/" + $path + "/" + $date + "-" + $slug + ".html")' blogger_feed.json | bash

      - name: Commit and Push Changes
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add _posts/
          git commit -m "Update Blogger Feed to Jekyll Format" || exit 0
          git push
