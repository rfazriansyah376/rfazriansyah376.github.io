<script>
// Fungsi untuk mengacak array (Fisher-Yates shuffle)
function shuffleArray(array) {
  const shuffled = [...array];
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }
  return shuffled;
}

// Fungsi utama pencarian
async function runSearch() {
  const params = new URLSearchParams(window.location.search);
  const query = (params.get("q") || "").toLowerCase().trim();
  const container = document.getElementById("searchResults");

  // Format query untuk display
  const formattedQuery = query
    .replace(/\+/g, ' ')
    .split(' ')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');

  // Jika tidak ada query
  if (!query) {
    container.innerHTML = `
      <div class="search-empty">
        <p>üîç Enter a search term in the URL like: <code>?q=your+keywords</code></p>
        <p>Or check out these random posts:</p>
      </div>
    `;
    await loadRandomPosts(container);
    return;
  }

  // Tampilkan loading state
  container.innerHTML = ``;

  try {
    // 1. Fetch data pencarian
    const response = await fetch("/search.json");
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    const allPosts = await response.json();

    // 2. Filter hasil pencarian
    const results = allPosts.filter(post => {
      const searchText = `
        ${post.title || ''}
        ${post.content || ''}
        ${post.excerpt || ''}
      `.toLowerCase();
      return searchText.includes(query);
    });

    // 3. Tampilkan hasil atau fallback
    if (results.length > 0) {
      displaySearchResults(results, query, formattedQuery, container);
    } else {
      // Tampilkan pesan no results DAN load random posts
      container.innerHTML = `
        <div class="no-results">
          <p>Results for "<strong>${escapeHtml(formattedQuery)}</strong>"</p>
        </div>
      `;
      await loadRandomPosts(container);
    }

  } catch (error) {
    console.error("Search error:", error);
    container.innerHTML = `
      <div class="search-error">
        <p>‚ö†Ô∏è Search temporarily unavailable.</p>
        <p>Showing random posts instead:</p>
      </div>
    `;
    await loadRandomPosts(container);
  }
}

// Fungsi: Tampilkan hasil pencarian
function displaySearchResults(results, query, formattedQuery, container) {
  // Escape query untuk regex
  const escapedQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  const highlightRegex = new RegExp(`(${escapedQuery})`, 'gi');

  const html = results.map(post => {
    // Highlight di title (TANPA LINK)
    const highlightedTitle = post.title.replace(
      highlightRegex, 
      '<mark class="highlight">$1</mark>'
    );

    // Cari snippet dengan keyword
    let snippet = post.excerpt || post.content.substring(0, 50);
    const contentLower = (post.content || '').toLowerCase();
    const queryIndex = contentLower.indexOf(query);
    
    if (queryIndex !== -1) {
      const start = Math.max(0, queryIndex - 80);
      const end = Math.min(post.content.length, queryIndex + query.length + 80);
      snippet = post.content.substring(start, end);
      snippet = snippet.replace(highlightRegex, '<mark class="highlight">$1</mark>');
      snippet = (start > 0 ? '...' : '') + snippet + (end < post.content.length ? '...' : '');
    }

    // Format URL dengan domain saat ini
    let postUrl = post.url;
    if (postUrl && !postUrl.startsWith('http')) {
      const currentDomain = window.location.origin;
      postUrl = currentDomain + (postUrl.startsWith('/') ? postUrl : '/' + postUrl);
    }

    return `
      <div class="search-result">
        <h3>${highlightedTitle}</h3>
        <div style="margin-bottom: 10px;">
          <a href="${postUrl}">
            <img src="/photo/fallback.png" 
                 alt="${escapeHtml(formattedQuery)}" 
                 loading="lazy" 
                 style="max-width:100%; height:auto; border-radius: 5px;">
          </a>
        </div>
        <p class="snippet">${snippet}</p>
      </div>
    `;
  }).join('');

  container.innerHTML = `
    <div class="results-found">
      <p class="results-count">Found ${results.length} result${results.length !== 1 ? 's' : ''} for "${escapeHtml(formattedQuery)}"</p>
      ${html}
    </div>
  `;
}

// Fungsi: Load random posts untuk fallback
async function loadRandomPosts(container) {
  try {
    const randomResponse = await fetch("/posts-acak.json");
    if (!randomResponse.ok) throw new Error(`Failed to load random posts: HTTP ${randomResponse.status}`);
    
    const allPosts = await randomResponse.json();
    
    if (!Array.isArray(allPosts) || allPosts.length === 0) {
      throw new Error("Random posts data is empty or invalid");
    }
    
    // Acak postingan setiap kali fungsi dipanggil
    const shuffledPosts = shuffleArray(allPosts);
    
    // Ambil 6 post pertama dari array yang sudah diacak
    const selectedPosts = shuffledPosts.slice(0, 9);
    
    const randomPostsHTML = selectedPosts.map(post => {
      // Format URL dengan domain saat ini
      let postUrl = post.url;
      if (postUrl && !postUrl.startsWith('http')) {
        const currentDomain = window.location.origin;
        postUrl = currentDomain + (postUrl.startsWith('/') ? postUrl : '/' + postUrl);
      }
      
      const excerpt = post.excerpt || '';
      const title = post.title || 'Untitled Post';
      
      return `
        <div class="random-post">
          <div style="margin-bottom: 10px;">
            <a href="${postUrl}">
              <img src="/photo/fallback.png" 
                   alt="${escapeHtml(title)}" 
                   loading="lazy" 
                   style="max-width:100%; height:auto; border-radius: 5px;">
            </a>
          </div>
          <h4>${title}</h4>
          ${excerpt ? `<p class="excerpt">${excerpt}</p>` : ''}
        </div>
      `;
    }).join('');
    
    const fallbackContainer = document.createElement('div');
    fallbackContainer.className = 'random-posts-fallback';
    fallbackContainer.innerHTML = `
      <div class="fallback-header">
      </div>
      <div class="random-posts-grid">
        ${randomPostsHTML}
      </div>
      <div class="fallback-footer">
        <a href="/" class="browse-all">Browse All Posts ‚Üí</a>
      </div>
    `;
    
    // Jika sudah ada fallback container sebelumnya, hapus dulu
    const existingFallback = container.querySelector('.random-posts-fallback');
    if (existingFallback) {
      existingFallback.remove();
    }
    
    container.appendChild(fallbackContainer);
    
    // Tambahkan event listener untuk tombol refresh
    const refreshBtn = fallbackContainer.querySelector('.refresh-btn');
    if (refreshBtn) {
      refreshBtn.addEventListener('click', function(e) {
        e.preventDefault();
        // Dapatkan container dari DOM
        const container = document.getElementById('searchResults');
        const fallbackSection = container.querySelector('.random-posts-fallback');
        if (fallbackSection) {
          // Hapus fallback section yang ada
          fallbackSection.remove();
          // Load random posts baru
          loadRandomPosts(container);
        }
      });
    }
    
  } catch (error) {
    console.error("Failed to load random posts:", error);
    
    // Jika error, tampilkan pesan error yang jelas
    const errorContainer = document.createElement('div');
    errorContainer.className = 'fallback-error';
    errorContainer.innerHTML = `
    `;
    
    container.appendChild(errorContainer);
  }
}

// Helper: Escape HTML untuk keamanan
function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Jalankan pencarian saat halaman siap
document.addEventListener('DOMContentLoaded', runSearch);
</script>
