---
---

{% comment %} 
  Kode untuk menghandle tags dengan normalisasi
  - Mengubah ke lowercase
  - Menghilangkan spasi berlebih
  - Mengganti hyphen dengan spasi
  - Mengumpulkan posts berdasarkan tag yang dinormalisasi
{% endcomment %}

{% assign raw_tags = "" %}
{% for post in site.posts %}
  {% for tag in post.tags %}
    {% assign normalized_tag = tag | downcase | replace: "-", " " | strip %}
    {% unless raw_tags contains normalized_tag %}
      {% assign raw_tags = raw_tags | append: normalized_tag | append: "|" %}
    {% endunless %}
  {% endfor %}
{% endfor %}

{% assign tag_names = raw_tags | split: "|" | sort %}

{% comment %} 
  Membuat hash map untuk mengelompokkan posts berdasarkan tag yang dinormalisasi
{% endcomment %}

{% assign tag_posts_map = "" | split: "" %}
{% assign tag_counts_map = "" | split: "" %}

{% for tag_name in tag_names %}
  {% assign normalized_tag = tag_name | downcase | replace: "-", " " | strip %}
  
  {% comment %} Cari semua posts yang memiliki tag (dalam berbagai format) {% endcomment %}
  {% assign posts_for_tag = "" | split: "" %}
  
  {% for post in site.posts %}
    {% for post_tag in post.tags %}
      {% assign normalized_post_tag = post_tag | downcase | replace: "-", " " | strip %}
      {% if normalized_post_tag == normalized_tag %}
        {% unless posts_for_tag contains post %}
          {% assign posts_for_tag = posts_for_tag | push: post %}
        {% endunless %}
      {% endif %}
    {% endfor %}
  {% endfor %}
  
  {% assign posts_count = posts_for_tag | size %}
  
  {% if posts_count > 0 %}
    {% comment %} Simpan dalam array objects {% endcomment %}
    {% capture tag_data %}
      {
        "name": "{{ tag_name }}",
        "display_name": "{{ tag_name | capitalize }}",
        "normalized": "{{ normalized_tag }}",
        "count": {{ posts_count }},
        "original_variations": [],
        "posts": []
      }
    {% endcapture %}
    
    {% assign tag_posts_map = tag_posts_map | push: tag_data %}
    {% assign tag_counts_map = tag_counts_map | push: posts_count %}
  {% endif %}
{% endfor %}

{% comment %} 
  Urutkan berdasarkan jumlah posts (descending)
{% endcomment %}

{% assign sorted_tag_data = "" | split: "" %}
{% assign tag_counts_sorted = tag_counts_map | sort | reverse %}

{% for count in tag_counts_sorted %}
  {% for tag_item in tag_posts_map %}
    {% assign tag_obj = tag_item | strip %}
    {% if tag_obj contains '"count": {{ count }}' %}
      {% unless sorted_tag_data contains tag_obj %}
        {% assign sorted_tag_data = sorted_tag_data | push: tag_obj %}
      {% endunless %}
    {% endif %}
  {% endfor %}
{% endfor %}

<div id="tags-box" class="tags-container" role="region" aria-label="Blog Tags">
  <!-- SEMUA tags ditampilkan (visible untuk SEO) -->
  <div id="all-tags-container" class="tags-wrapper">
    {% for tag_json in sorted_tag_data %}
      {% assign tag = tag_json | strip | replace: '&quot;', '"' %}
      {% assign tag_obj = tag | parse_json %}
      
      {% comment %} 
        Untuk display name, gunakan original format yang paling umum
        atau format yang sudah dinormalisasi
      {% endcomment %}
      
      {% assign display_name = tag_obj.display_name %}
      {% assign tag_count = tag_obj.count %}
      {% assign tag_slug = tag_obj.normalized | replace: " ", "-" | downcase %}
      
      <a class="taglink all-tag" 
         rel="tag"
         aria-label="View posts tagged {{ display_name }} ({{ tag_count }} posts)"
         href="/tag/{{ tag_slug }}/"
         data-normalized="{{ tag_obj.normalized }}"
         style="display:block; margin:6px 0; {% if forloop.index > 20 %}opacity:0.7; height:0; overflow:hidden; margin:0;{% endif %}">
        <span class="tag-name">{{ display_name }}</span>
        <span class="tag-count" aria-hidden="true">({{ tag_count }})</span>
      </a>
    {% endfor %}
  </div>
  
  {% assign total_tags = sorted_tag_data | size %}
  {% if total_tags > 20 %}
    <div class="tags-footer" style="text-align:center; margin:15px 0;">
      <button id="view-more-tags" 
              aria-expanded="false"
              aria-controls="all-tags-container"
              class="tags-toggle-btn"
              style="padding:8px 20px; background:#fff; border:2px solid #007bff; color:#007bff; border-radius:20px; cursor:pointer; font-weight:bold;">
        <span class="toggle-text">↓ View All {{ total_tags }} Tags ↓</span>
      </button>
      <div class="tags-count-info" style="font-size:12px; color:#666; margin-top:5px;" aria-live="polite">
        Showing 20 of {{ total_tags }} unique tags
      </div>
    </div>
  {% endif %}
</div>

<style>
  .tags-container {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  }
  
  #all-tags-container {
    max-height: 500px;
    overflow: hidden;
    transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
  }
  
  #all-tags-container.expanded {
    max-height: 4000px;
  }
  
  .all-tag {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    text-decoration: none;
    color: #333;
    padding: 4px 12px;
    border-radius: 16px;
    background: #f8f9fa;
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }
  
  .all-tag:hover {
    background: #e9ecef;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .tag-name {
    font-weight: 500;
  }
  
  .tag-count {
    font-size: 0.85em;
    opacity: 0.8;
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", function(){
  const VISIBLE_TAGS = 20;
  const viewMoreBtn = document.getElementById("view-more-tags");
  const tagsContainer = document.getElementById("all-tags-container");
  const allTags = document.querySelectorAll(".all-tag");
  
  if(viewMoreBtn && tagsContainer && allTags.length > VISIBLE_TAGS){
    let isExpanded = false;
    
    viewMoreBtn.addEventListener("click", function(){
      if(!isExpanded){
        expandTags();
      } else {
        collapseTags();
      }
    });
    
    function expandTags() {
      isExpanded = true;
      tagsContainer.classList.add("expanded");
      viewMoreBtn.classList.add("expanded");
      viewMoreBtn.setAttribute("aria-expanded", "true");
      viewMoreBtn.querySelector(".toggle-text").textContent = `↑ Collapse Tags ↑`;
      
      document.querySelector(".tags-count-info").textContent = 
        `Showing all ${allTags.length} unique tags`;
      
      allTags.forEach(function(tag, index){
        if(index >= VISIBLE_TAGS){
          setTimeout(function(){
            tag.style.height = "auto";
            tag.style.opacity = "1";
            tag.style.margin = "6px 0";
          }, (index - VISIBLE_TAGS) * 10);
        }
      });
    }
    
    function collapseTags() {
      isExpanded = false;
      tagsContainer.classList.remove("expanded");
      viewMoreBtn.classList.remove("expanded");
      viewMoreBtn.setAttribute("aria-expanded", "false");
      viewMoreBtn.querySelector(".toggle-text").textContent = 
        `↓ View All ${allTags.length} Tags ↓`;
      
      document.querySelector(".tags-count-info").textContent = 
        `Showing ${VISIBLE_TAGS} of ${allTags.length} unique tags`;
      
      allTags.forEach(function(tag, index){
        if(index >= VISIBLE_TAGS){
          tag.style.height = "0";
          tag.style.opacity = "0.7";
          tag.style.margin = "0";
        }
      });
    }
  }
});
</script>
